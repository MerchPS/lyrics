<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tabola Bale - AI Sync Lyrics</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #ff4d4d;
      --secondary: #ffcc00;
      --dark: #0a0a0a;
      --light: #f8f8f8;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(135deg, var(--dark), #1a1a1a);
      color: var(--light);
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    
    header {
      text-align: center;
      margin-bottom: 2rem;
      width: 100%;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .artist {
      font-size: 1.2rem;
      color: #aaa;
      margin-bottom: 1rem;
    }
    
    .audio-container {
      width: 100%;
      max-width: 500px;
      margin: 0 auto 2rem;
      position: relative;
    }
    
    audio {
      width: 100%;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .control-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    
    .control-btn {
      padding: 8px 16px;
      border-radius: 20px;
      background: rgba(255,255,255,0.1);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    
    .control-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .control-btn.active {
      background: var(--primary);
    }
    
    .lyrics-container {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      position: relative;
      min-height: 60vh;
      perspective: 1000px;
      overflow: hidden;
    }
    
    .lyrics-scroller {
      transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.4, 1);
    }
    
    .lyrics-line {
      width: 100%;
      text-align: center;
      font-size: 2rem;
      font-weight: 600;
      margin: 1.5rem 0;
      opacity: 0.3;
      transition: all 0.5s cubic-bezier(0.2, 0.8, 0.4, 1);
      transform: scale(0.95);
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
      line-height: 1.4;
    }
    
    .lyrics-line.active {
      opacity: 1;
      transform: scale(1);
    }
    
    .lyrics-line.highlight {
      color: var(--secondary);
      font-size: 2.2rem;
      opacity: 1;
      text-shadow: 0 0 15px rgba(255,204,0,0.7);
    }
    
    .lyrics-line.rap {
      font-size: 1.8rem;
      color: var(--primary);
      font-weight: 700;
      opacity: 1;
    }
    
    .lyrics-line.past {
      opacity: 0.2;
      transform: scale(0.9);
    }
    
    .progress-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: rgba(255,255,255,0.1);
      z-index: 100;
    }
    
    .progress {
      height: 100%;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      width: 0%;
      transition: width 0.1s linear;
    }
    
    .status-panel {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 0.8rem;
      color: #ccc;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .status-dot.loading {
      background: #ffcc00;
      box-shadow: 0 0 3px #ffcc00;
    }
    
    .status-dot.active {
      background: #0f0;
      box-shadow: 0 0 3px #0f0;
    }
    
    .status-dot.error {
      background: #f00;
      box-shadow: 0 0 3px #f00;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 15px;
      font-size: 1.2rem;
    }
    
    .offset-display {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 0.9rem;
    }
    
    /* New elements for enhanced features */
    .bpm-meter {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .bpm-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--secondary);
    }
    
    .vocal-graph {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 200px;
      height: 60px;
      background: rgba(0,0,0,0.5);
      border-radius: 5px;
      overflow: hidden;
    }
    
    .vocal-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #00ff00, #ffcc00);
      transition: width 0.1s;
    }
    
    .advanced-controls {
      position: fixed;
      bottom: 60px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .sync-confidence {
      position: fixed;
      top: 150px;
      right: 20px;
      width: 200px;
      height: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
      overflow: hidden;
    }
    
    .confidence-level {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #ff0000, #ffcc00, #00ff00);
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loading-text">Initializing Advanced Player...</div>
  </div>

  <header>
    <h1>Tabola Bale</h1>
    <div class="artist">Silet Open Up ft. Jacson Zeran, Juan Reza, Diva Aurel</div>
    <div class="audio-container">
      <audio id="audio" controls>
        <source src="ytmp3free.cc_tabola-bale-silet-open-up-ft-jacson-zeran-juan-reza-diva-aurel-lirik-lagu-timur-terbaru-2025-youtubemp3free.org.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
      <div class="control-panel">
        <button class="control-btn" id="sync-back">← 0.1s</button>
        <button class="control-btn" id="sync-forward">→ 0.1s</button>
        <button class="control-btn" id="sync-reset">Reset Sync</button>
        <button class="control-btn" id="ai-toggle">AI Mode</button>
      </div>
    </div>
  </header>
  
  <div class="lyrics-container">
    <div class="lyrics-scroller" id="lyrics"></div>
  </div>
  
  <div class="progress-container">
    <div class="progress" id="progress"></div>
  </div>

  <!-- New UI Elements -->
  <div class="bpm-meter">
    <div class="bpm-value" id="bpm-value">-- BPM</div>
    <div>Real-time BPM</div>
  </div>
  
  <div class="vocal-graph">
    <div class="vocal-bar" id="vocal-bar"></div>
  </div>
  
  <div class="sync-confidence">
    <div class="confidence-level" id="confidence-level"></div>
  </div>
  
  <div class="offset-display" id="offset-display">Sync Offset: 0.0s</div>

  <div class="advanced-controls">
    <button class="control-btn" id="bpm-lock">Lock BPM</button>
    <button class="control-btn" id="vocal-sensitivity">Vocal Sensitivity: Medium</button>
  </div>

  <div class="status-panel">
    <div class="status-item">
      <div class="status-dot active" id="ai-status-dot"></div>
      <span id="ai-status-text">AI Active</span>
    </div>
    <div class="status-item">
      <div class="status-dot active" id="bpm-status-dot"></div>
      <span id="bpm-status-text">BPM: Detecting...</span>
    </div>
    <div class="status-item">
      <div class="status-dot" id="vocal-status-dot"></div>
      <span id="vocal-status-text">Vocals: Analyzing...</span>
    </div>
  </div>

  <script>
    // ===== COMPLETE LYRICS DATA ===== //
    const lyrics = [
      // Intro
      { time: 0.0, text: "", type: "hidden", vocalStart: 2.1 },
      { time: 2.1, text: "Kaka tabola bale lia ade nona e", type: "normal", vocalStart: 2.1 },
      { time: 5.8, text: "Su makin manyala e", type: "normal", vocalStart: 5.8 },
      { time: 9.5, text: "Kaka hati susah e", type: "normal", vocalStart: 9.5 },
      { time: 13.2, text: "Dulu denai la suko mancaliak uda bakawan", type: "normal", vocalStart: 13.2 },
      { time: 17.0, text: "Raso-raso ko ado, tapi denai diamkan (hei!)", type: "highlight", vocalStart: 17.0 },
      
      // Verse 1
      { time: 21.5, text: "Lia ade nona makin gaga", type: "normal", vocalStart: 21.7 },
      { time: 25.2, text: "Bikin kaka jadi suka", type: "normal", vocalStart: 25.4 },
      { time: 28.8, text: "Dulu ade rambu kepang dua", type: "normal", vocalStart: 29.0 },
      { time: 32.5, text: "Sekarang rambu merah merah", type: "highlight", vocalStart: 32.7 },
      { time: 36.2, text: "Kaka lia ade tambah manis", type: "normal", vocalStart: 36.4 },
      { time: 39.9, text: "Pulang rantau dari mana", type: "normal", vocalStart: 40.1 },
      { time: 43.6, text: "Adu ade nona jang talalu", type: "normal", vocalStart: 43.8 },
      { time: 47.3, text: "Pasang gaya depan kaka", type: "highlight", vocalStart: 47.5 },
      { time: 51.0, text: "Kaka jadi jatoh e", type: "normal", vocalStart: 51.2 },
      
      // Chorus
      { time: 54.7, text: "Kaka tabola bale lia ade nona e", type: "normal", vocalStart: 54.9 },
      { time: 58.4, text: "Su makin manyala e", type: "normal", vocalStart: 58.6 },
      { time: 62.1, text: "Kaka hati susah e", type: "normal", vocalStart: 62.3 },
      { time: 65.8, text: "Ade bikin kaka mete", type: "normal", vocalStart: 66.0 },
      { time: 69.5, text: "Tidur malam bola bale", type: "normal", vocalStart: 69.7 },
      { time: 73.2, text: "Sejak kaka lia ade", type: "normal", vocalStart: 73.4 },
      { time: 76.9, text: "Aduh Tuhan ampun e", type: "highlight", vocalStart: 77.1 },
      
      // Rap 1
      { time: 80.6, text: "Ade lewat lorong depan rumah", type: "rap", vocalStart: 80.6 },
      { time: 82.4, text: "Kaka jadi salting sampe mood berubah", type: "rap", vocalStart: 82.4 },
      { time: 84.2, text: "Smangat tiba-tiba gara-gara ade nona", type: "rap", vocalStart: 84.2 },
      { time: 86.0, text: "Ini bidadari timur siapa yang punya", type: "rap", vocalStart: 86.0 },
      { time: 87.8, text: "Kaka lacak ko pu nama", type: "rap", vocalStart: 87.8 },
      { time: 89.6, text: "Barang itu tra pake lama", type: "rap", vocalStart: 89.6 },
      { time: 91.4, text: "Langsung tanya di ko pu mama", type: "rap", vocalStart: 91.4 },
      { time: 93.2, text: "Ternyata ade nona ko pu nama maimuna", type: "rap", vocalStart: 93.2 },
      { time: 95.0, text: "Eh maimuna ehh lucunya", type: "rap", vocalStart: 95.0 },
      { time: 96.8, text: "Kaka harap bisa satu rumah", type: "rap", vocalStart: 96.8 },
      { time: 98.6, text: "Kalo trima sa pu cinta", type: "rap", vocalStart: 98.6 },
      { time: 100.4, text: "Kaka janji kita langsung menikah", type: "rap", vocalStart: 100.4 },
      
      // Verse 2
      { time: 104.1, text: "Ondeh uda jan baitu bana", type: "normal", vocalStart: 104.3 },
      { time: 107.8, text: "Denai ko indaklah nan sarupo itu", type: "normal", vocalStart: 108.0 },
      { time: 111.5, text: "Dek hanyo takuik mancaliak uda", type: "normal", vocalStart: 111.7 },
      { time: 115.2, text: "Acok mabuak mabuakan", type: "highlight", vocalStart: 115.4 },
      { time: 118.9, text: "Dulu denai lah suko", type: "normal", vocalStart: 119.1 },
      { time: 122.6, text: "Mancaliak uda bakawan", type: "normal", vocalStart: 122.8 },
      { time: 126.3, text: "Raso raso ko ado", type: "normal", vocalStart: 126.5 },
      { time: 130.0, text: "Tapi denai diamkan", type: "highlight", vocalStart: 130.2 },
      
      // Rap 2
      { time: 133.7, text: "A wadaw wadaw ini ana gaga law", type: "rap", vocalStart: 133.7 },
      { time: 135.5, text: "Su bale jawa tamba bening aja la", type: "rap", vocalStart: 135.5 },
      { time: 137.3, text: "Gaya semakin beda bibir mera mera", type: "rap", vocalStart: 137.3 },
      { time: 139.1, text: "Ado mama mama ini siapa punya ana", type: "rap", vocalStart: 139.1 },
      { time: 140.9, text: "Dulu masi kici kici kici nona", type: "rap", vocalStart: 140.9 },
      { time: 142.7, text: "Sekarang bale jawa makin cantik nona", type: "rap", vocalStart: 142.7 },
      { time: 144.5, text: "Ko perfek sekali asli bidadari", type: "rap", vocalStart: 144.5 },
      { time: 146.3, text: "Jatuh dari langit", type: "rap", vocalStart: 146.3 },
      
      // Bridge
      { time: 148.1, text: "Kalo jadi dengan ade", type: "normal", vocalStart: 148.3 },
      { time: 151.8, text: "Kaka pasti stop bamabo to", type: "normal", vocalStart: 152.0 },
      { time: 155.5, text: "Su pasti kaka ni ade pu jodoh", type: "normal", vocalStart: 155.7 },
      { time: 159.2, text: "Sumpa ni jao sodho iwa mbodho", type: "highlight", vocalStart: 159.4 },
      
      // Final Chorus
      { time: 162.9, text: "Lia ade nona makin gaga", type: "normal", vocalStart: 163.1 },
      { time: 166.6, text: "Bikin kaka jadi suka", type: "normal", vocalStart: 166.8 },
      { time: 170.3, text: "Dulu ade rambu kepang dua", type: "normal", vocalStart: 170.5 },
      { time: 174.0, text: "Sekarang rambu merah merah", type: "highlight", vocalStart: 174.2 },
      { time: 177.7, text: "Kaka lia ade tambah manis", type: "normal", vocalStart: 177.9 },
      { time: 181.4, text: "Pulang rantau dari mana", type: "normal", vocalStart: 181.6 },
      { time: 185.1, text: "Adu ade nona jang talalu", type: "normal", vocalStart: 185.3 },
      { time: 188.8, text: "Pasang gaya depan kaka", type: "highlight", vocalStart: 189.0 },
      { time: 192.5, text: "Kaka jadi jatoh e", type: "normal", vocalStart: 192.7 },
      { time: 196.2, text: "Kaka tabola bale lia ade nona e", type: "normal", vocalStart: 196.4 },
      { time: 199.9, text: "Su makin manyala e", type: "normal", vocalStart: 200.1 },
      { time: 203.6, text: "Kaka hati susah e", type: "normal", vocalStart: 203.8 },
      { time: 207.3, text: "Ade bikin kaka mete", type: "normal", vocalStart: 207.5 },
      { time: 211.0, text: "Tidur malam bola bale", type: "normal", vocalStart: 211.2 },
      { time: 214.7, text: "Sejak kaka lia ade", type: "normal", vocalStart: 214.9 },
      { time: 218.4, text: "Aduh Tuhan ampun e", type: "highlight", vocalStart: 218.6 },
      { time: 222.1, text: "Ade bikin kaka mete", type: "normal", vocalStart: 222.3 },
      { time: 225.8, text: "Tidur malam bola bale", type: "normal", vocalStart: 226.0 },
      { time: 229.5, text: "Sejak kaka lia ade", type: "normal", vocalStart: 229.7 },
      { time: 233.2, text: "Aduh Tuhan ampun e", type: "highlight", vocalStart: 233.4 }
    ];

    // ===== MAIN APPLICATION ===== //
    const audio = document.getElementById('audio');
    const lyricsContainer = document.getElementById('lyrics');
    const progressBar = document.getElementById('progress');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const aiStatusDot = document.getElementById('ai-status-dot');
    const aiStatusText = document.getElementById('ai-status-text');
    const bpmStatusDot = document.getElementById('bpm-status-dot');
    const bpmStatusText = document.getElementById('bpm-status-text');
    const vocalStatusDot = document.getElementById('vocal-status-dot');
    const vocalStatusText = document.getElementById('vocal-status-text');
    const syncBackBtn = document.getElementById('sync-back');
    const syncForwardBtn = document.getElementById('sync-forward');
    const syncResetBtn = document.getElementById('sync-reset');
    const aiToggleBtn = document.getElementById('ai-toggle');
    const offsetDisplay = document.getElementById('offset-display');
    const bpmValue = document.getElementById('bpm-value');
    const vocalBar = document.getElementById('vocal-bar');
    const confidenceLevel = document.getElementById('confidence-level');
    const bpmLockBtn = document.getElementById('bpm-lock');
    const vocalSensitivityBtn = document.getElementById('vocal-sensitivity');

    // State variables
    let audioContext;
    let analyser;
    let processor;
    let isAIActive = true;
    let currentBPM = 125;
    let detectedBPM = 125;
    let isBpmLocked = false;
    let vocalSensitivity = 1; // 0=low, 1=medium, 2=high
    let lastVocalTime = 0;
    let isVocalActive = false;
    let globalOffset = 0;
    let currentActiveIndex = -1;
    let isPlaying = false;
    let animationFrameId;
    let lastUpdateTime = 0;
    let beatTimes = [];
    let confidence = 0.8;

    // ===== CORE FUNCTIONS ===== //

    // Initialize everything
    async function initialize() {
      try {
        // 1. Load audio metadata first
        loadingText.textContent = "Loading audio...";
        await loadAudioMetadata();
        
        // 2. Initialize Web Audio API with advanced processing
        loadingText.textContent = "Initializing audio analysis...";
        initAudioAnalysis();
        
        // 3. Load lyrics
        loadingText.textContent = "Preparing lyrics...";
        initLyrics();
        
        // 4. Initialize BPM detection
        loadingText.textContent = "Preparing BPM detection...";
        initBPMDetection();
        
        // Hide loading overlay
        setTimeout(() => {
          loadingOverlay.style.opacity = '0';
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
          }, 300);
        }, 1000);
        
        // Update initial status
        updateAIStatus("AI Active", "active");
        updateBPMStatus("BPM: Detecting...", "active");
        updateVocalStatus("Vocals: Analyzing...", "loading");
        updateOffsetDisplay();
      } catch (error) {
        console.error("Initialization error:", error);
        loadingText.textContent = "Error initializing. Please refresh.";
        loadingText.style.color = "#ff4d4d";
      }
    }

    // Load audio metadata
    function loadAudioMetadata() {
      return new Promise((resolve, reject) => {
        if (audio.readyState > 0) {
          resolve();
          return;
        }
        
        const onLoaded = () => {
          audio.removeEventListener('loadedmetadata', onLoaded);
          audio.removeEventListener('error', onError);
          resolve();
        };
        
        const onError = () => {
          audio.removeEventListener('loadedmetadata', onLoaded);
          audio.removeEventListener('error', onError);
          reject(new Error("Audio failed to load"));
        };
        
        audio.addEventListener('loadedmetadata', onLoaded);
        audio.addEventListener('error', onError);
      });
    }

    // Initialize Web Audio API with advanced processing
    function initAudioAnalysis() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaElementSource(audio);
        
        // Create analyser for frequency analysis
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        
        // Create script processor for time-domain analysis
        processor = audioContext.createScriptProcessor(4096, 1, 1);
        processor.onaudioprocess = processAudio;
        
        // Connect nodes
        source.connect(analyser);
        analyser.connect(processor);
        processor.connect(audioContext.destination);
      } catch (error) {
        console.error("AudioContext error:", error);
        updateBPMStatus("Audio Error", "error");
      }
    }

    // Initialize BPM detection system
    function initBPMDetection() {
      // Start with default BPM
      updateBPMValue(currentBPM);
      
      // Update BPM every second based on detected beats
      setInterval(() => {
        if (!isPlaying || isBpmLocked) return;
        
        // Calculate BPM from beat intervals
        if (beatTimes.length > 2) {
          const intervals = [];
          for (let i = 1; i < beatTimes.length; i++) {
            intervals.push(beatTimes[i] - beatTimes[i-1]);
          }
          
          // Calculate average interval
          const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
          detectedBPM = Math.round(60 / avgInterval);
          
          // Only update if BPM is reasonable (80-200 range)
          if (detectedBPM > 80 && detectedBPM < 200) {
            currentBPM = detectedBPM;
            updateBPMValue(currentBPM);
            updateBPMStatus(`BPM: ${currentBPM}`, "active");
            
            // Calculate confidence based on beat consistency
            const variance = intervals.reduce((sum, int) => sum + Math.pow(int - avgInterval, 2), 0) / intervals.length;
            confidence = Math.max(0, 1 - (variance / 0.01)); // Normalize variance
            updateConfidence(confidence);
          }
        }
        
        // Clear old beats (keep last 10 seconds)
        const now = audio.currentTime;
        beatTimes = beatTimes.filter(time => now - time < 10);
      }, 1000);
    }

    // Process audio data for beat and vocal detection
    function processAudio(event) {
      if (!isPlaying) return;
      
      // Get time domain data for beat detection
      const inputBuffer = event.inputBuffer;
      const inputData = inputBuffer.getChannelData(0);
      
      // Simple beat detection (energy threshold)
      let sum = 0;
      for (let i = 0; i < inputData.length; i++) {
        sum += Math.abs(inputData[i]);
      }
      const rms = Math.sqrt(sum / inputData.length);
      
      // Detect beat if energy is above threshold
      if (rms > 0.15) { // Adjust threshold as needed
        beatTimes.push(audio.currentTime);
      }
      
      // Vocal detection (using frequency analysis)
      detectVocals();
    }

    // Advanced vocal detection with 3-stage analysis
    function detectVocals() {
      try {
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);
        
        // Stage 1: Frequency analysis (300Hz-3kHz)
        const low = Math.floor(300 / (audioContext.sampleRate / bufferLength));
        const high = Math.floor(3000 / (audioContext.sampleRate / bufferLength));
        let vocalSum = 0;
        for (let i = low; i < high; i++) {
          vocalSum += dataArray[i];
        }
        const vocalAvg = vocalSum / (high - low);
        
        // Stage 2: Amplitude analysis
        const overallSum = dataArray.reduce((a, b) => a + b, 0);
        const overallAvg = overallSum / bufferLength;
        
        // Stage 3: Ratio analysis
        const ratio = vocalAvg / (overallAvg + 0.001); // Avoid division by zero
        
        // Determine vocal presence based on sensitivity
        let threshold;
        switch(vocalSensitivity) {
          case 0: threshold = 1.8; break; // Low sensitivity
          case 1: threshold = 1.5; break; // Medium sensitivity
          case 2: threshold = 1.2; break; // High sensitivity
        }
        
        const newVocalState = ratio > threshold;
        
        // Update vocal bar visualization
        const vocalLevel = Math.min(100, Math.max(0, (ratio - 1) * 100));
        vocalBar.style.width = `${vocalLevel}%`;
        
        // Only update if state changed
        if (newVocalState !== isVocalActive) {
          isVocalActive = newVocalState;
          updateVocalStatus(
            isVocalActive ? "Vocals: Active" : "Vocals: Inactive",
            isVocalActive ? "active" : "error"
          );
        }
        
        if (isVocalActive) {
          lastVocalTime = audio.currentTime;
        }
      } catch (error) {
        console.error("Vocal detection error:", error);
        isVocalActive = false;
      }
    }

    // Initialize lyrics
    function initLyrics() {
      lyrics.forEach((line, index) => {
        if (line.type === "hidden") return;
        
        const lyricElement = document.createElement('div');
        lyricElement.className = `lyrics-line ${line.type}`;
        lyricElement.textContent = line.text;
        lyricElement.dataset.index = index;
        lyricsContainer.appendChild(lyricElement);
      });
    }

    // Update lyrics display with AI-enhanced timing
    function updateLyrics() {
      if (!isPlaying) return;
      
      const currentTime = audio.currentTime + globalOffset;
      const now = performance.now();
      
      // Find the current active line with AI considerations
      let newActiveIndex = -1;
      for (let i = lyrics.length - 1; i >= 0; i--) {
        const line = lyrics[i];
        
        // Calculate dynamic threshold based on BPM and confidence
        const bpmFactor = 120 / currentBPM; // Normalize to 120 BPM
        const dynamicThreshold = 0.3 * bpmFactor * confidence;
        
        // Check if we should show this line
        if (currentTime >= line.time) {
          // For rap lines, show immediately with tighter timing
          if (line.type === "rap") {
            if (currentTime - line.time < dynamicThreshold * 0.7) {
              newActiveIndex = i;
              break;
            }
          }
          // For normal lines, consider vocal state
          else if (isVocalActive || (currentTime - line.time > dynamicThreshold * 2)) {
            newActiveIndex = i;
            break;
          }
          // For highlighted lines, show slightly earlier
          else if (line.type === "highlight" && currentTime - line.time < dynamicThreshold * 1.5) {
            newActiveIndex = i;
            break;
          }
        }
      }
      
      // Update display if active line changed
      if (newActiveIndex !== currentActiveIndex && newActiveIndex >= 0) {
        document.querySelectorAll('.lyrics-line').forEach((line, index) => {
          line.classList.remove('active', 'past', 'highlight');
          
          if (index === newActiveIndex) {
            line.classList.add('active');
            if (lyrics[index].type === "highlight") {
              line.classList.add('highlight');
            }
            
            // Smooth scroll to center the active line
            const container = document.querySelector('.lyrics-container');
            const scroller = document.querySelector('.lyrics-scroller');
            const lineTop = line.offsetTop;
            const containerHeight = container.offsetHeight;
            const scrollTo = lineTop - (containerHeight / 2) + (line.offsetHeight / 2);
            
            scroller.style.transform = `translateY(-${scrollTo}px)`;
          } else if (index < newActiveIndex) {
            line.classList.add('past');
          }
        });
        
        currentActiveIndex = newActiveIndex;
      }
      
      animationFrameId = requestAnimationFrame(updateLyrics);
    }

    // Update BPM display
    function updateBPMValue(bpm) {
      bpmValue.textContent = `${bpm} BPM`;
      
      // Color code based on BPM
      if (bpm < 100) {
        bpmValue.style.color = "#4dff4d"; // Green for slow
      } else if (bpm < 140) {
        bpmValue.style.color = "#ffcc00"; // Yellow for medium
      } else {
        bpmValue.style.color = "#ff4d4d"; // Red for fast
      }
    }

    // Update confidence display
    function updateConfidence(level) {
      confidenceLevel.style.width = `${level * 100}%`;
    }

    // Update status functions
    function updateAIStatus(text, state) {
      aiStatusText.textContent = text;
      aiStatusDot.className = 'status-dot';
      if (state === "active") aiStatusDot.classList.add('active');
      if (state === "error") aiStatusDot.classList.add('error');
    }

    function updateBPMStatus(text, state) {
      bpmStatusText.textContent = text;
      bpmStatusDot.className = 'status-dot';
      if (state === "active") bpmStatusDot.classList.add('active');
      if (state === "error") bpmStatusDot.classList.add('error');
    }

    function updateVocalStatus(text, state) {
      vocalStatusText.textContent = text;
      vocalStatusDot.className = 'status-dot';
      if (state === "active") vocalStatusDot.classList.add('active');
      if (state === "error") vocalStatusDot.classList.add('error');
    }

    function updateOffsetDisplay() {
      offsetDisplay.textContent = `Sync Offset: ${globalOffset.toFixed(1)}s`;
    }

    // ===== EVENT LISTENERS ===== //

    audio.addEventListener('play', () => {
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      isPlaying = true;
      lastUpdateTime = performance.now();
      updateLyrics();
    });

    audio.addEventListener('pause', () => {
      isPlaying = false;
      cancelAnimationFrame(animationFrameId);
    });

    audio.addEventListener('timeupdate', () => {
      const progress = (audio.currentTime / audio.duration) * 100;
      progressBar.style.width = `${progress}%`;
    });

    // Sync controls
    syncBackBtn.addEventListener('click', () => {
      globalOffset -= 0.1;
      updateOffsetDisplay();
    });

    syncForwardBtn.addEventListener('click', () => {
      globalOffset += 0.1;
      updateOffsetDisplay();
    });

    syncResetBtn.addEventListener('click', () => {
      globalOffset = 0;
      updateOffsetDisplay();
    });

    aiToggleBtn.addEventListener('click', () => {
      isAIActive = !isAIActive;
      aiToggleBtn.classList.toggle('active', isAIActive);
      updateAIStatus(
        isAIActive ? "AI Active" : "AI Disabled",
        isAIActive ? "active" : "error"
      );
    });

    bpmLockBtn.addEventListener('click', () => {
      isBpmLocked = !isBpmLocked;
      bpmLockBtn.classList.toggle('active', isBpmLocked);
      bpmLockBtn.textContent = isBpmLocked ? "BPM: Locked" : "Lock BPM";
    });

    vocalSensitivityBtn.addEventListener('click', () => {
      vocalSensitivity = (vocalSensitivity + 1) % 3;
      const levels = ["Low", "Medium", "High"];
      vocalSensitivityBtn.textContent = `Vocal Sensitivity: ${levels[vocalSensitivity]}`;
    });

    // Start initialization
    initialize();
  </script>
</body>
</html>
